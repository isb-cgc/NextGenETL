
version: 1

steps:
  - build_file_list_and_download
  - convert_excel_to_csv
  - normalize_tsv_and_create_schema
  - build_raw_tables
  - create_and_upload_merged_jsonl
  - create_merged_table
  # - publish_tables

params:
  RELEASE: r41
  EXTRACTED_MONTH_YEAR: 'December 2024'
  RELEASE_NOTES_URL: https://docs.gdc.cancer.gov/Data/Release_Notes/Data_Release_Notes/#data-release-410

  NODE: gdc

  LOGFILE_PATH: 'logs/gdc/clinical_from_file_TARGET.log'
  LOCATION: US

  # What bucket is going to get the text file heading to BQ?
  WORKING_BUCKET: next-gen-etl-scratch

  # What is the file path to the text file in the bucket:
  WORKING_BUCKET_DIR: law/gdc_clin # DO NOT HAVE A LEADING /

  # Where are the files going on the VM:
  SCRATCH_DIR: scratch/gdc_clinical_from_file

  # What project are we in:
  DEV_PROJECT: isb-project-zero

  # Where is the BQ table dataset:
  DEV_DATASET: clinical_from_files
  DEV_RAW_DATASET: clinical_from_files_raw
  DEV_FINAL_DATASET: clinical_from_files_final
  META_DATASET: GDC_metadata
  MANIFEST_DATASET: GDC_manifests
  PROD_PROJECT: isb-cgc-bq
  # PROD_PROJECT: isb-cgc-sandbox-000
  PROD_DATASET: TARGET

  PROD_TABLE_PREFIX: clinical_from_supplement_files

  OVERWRITE_PROD_TABLE: TRUE

  # location of column definition/table metadata template files
  BQ_REPO: BQEcosystem
  GENERIC_SCHEMA_DIR: GenericSchemas
  COLUMN_DESCRIPTION_FILEPATH: TableFieldUpdates/target_clin_file_column_descriptions.json
  METADATA_FILE_SINGLE_PROGRAM: clin_file_target.json

  EXCLUDED_COLUMNS:
    - initial_therapy
    - alal_presentation
    - who_alal_classification
    - who_rl1
    - who_dx
    - who_rl2
    - blast_count_used_for_rna_seq

  # What to name the merged table?
  MERGED_TABLE_NAME: TARGET

  # Where do we stash the manifest in the bucket after we get it:
  BUCKET_MANIFEST_TSV: manifest.tsv # DO NOT HAVE A LEADING /

  # Where do we stash the pull_list in the bucket after we get it:
  BUCKET_PULL_LIST: file_pull_list.txt # DO NOT HAVE A LEADING /

  BASE_FILE_NAME: clin_files

  # Source (dev) file metadata table name prefix (concatenated with [params['RELEASE'], '_', bq_params['FILE_TABLE_SUFFIX']])
  SRC_TABLE_PREFIX: rel

  # Source (dev) file metadata table name suffix (concatenated with [bq_params['FILE_TABLE_PREFIX'], params['RELEASE'], '_'])
  FILE_TABLE: fileData_current

  # Where is the table that maps gdc file IDs to gcs paths:
  INDEXD_TABLE: GDCfileID_to_GCSurl

  PROGRAM: TARGET

  FILTERS:
    program_name: "TARGET"
    data_format: "XLSX"
    data_category: "Clinical"

  HEADER_ROW_IDX: 0
  DATA_START_IDX: 1
  FILE_SUFFIX: xlsx
  ID_KEY: target_usi
